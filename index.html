<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>QR Puzzle â€“ iOS Friendly (Tap to Swap)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<style>
  /* ====== EASY SETTINGS ======
     Change grid size here: 3, 4, 5, ...
     Change size for desktop; mobile will auto-fit width */
  :root { --grid: 4; --desktop-size: 360px; }
  html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui,Segoe UI,Arial,sans-serif}
  .wrap{min-height:100%;display:grid;place-items:center;padding:16px}
  .puzzle{
    position:relative;
    width:min(var(--desktop-size), 90vw);
    aspect-ratio: 1 / 1;
    image-rendering: pixelated; /* keeps QR crisp */
    -webkit-user-select:none; user-select:none;
    -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent;
  }
  /* Real QR image sits underneath tiles */
  #qr{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}

  /* Tile grid on top */
  .grid{
    position:absolute;inset:0;display:grid;gap:1px;
    grid-template-columns: repeat(var(--grid), 1fr);
    grid-template-rows: repeat(var(--grid), 1fr);
    background:#000; /* gaps are black lines */
    pointer-events:auto;
  }
  .tile{
    background:#111;
    background-size: 100% 100%;
    outline:1px solid #000;
    transition: box-shadow .12s ease;
  }
  .tile.sel{ box-shadow: 0 0 0 3px #39ff14 inset; } /* neon highlight */
  .hidden{ opacity:0; pointer-events:none; }
  .banner{
    position:absolute;left:50%;top:calc(100% + 14px);transform:translateX(-50%);
    font-size:.95rem;color:#aaa;text-align:center
  }
  .toast{
    position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
    background:#111;border:1px solid #333;padding:10px 14px;border-radius:10px;color:#fff;
    font-size:.9rem;opacity:0;transition:opacity .2s ease
  }
  .toast.show{opacity:1}
</style>
</head>
<body>
<div class="wrap">
  <div class="puzzle" id="puzzle" aria-label="QR Tile Puzzle">
    <!-- The real QR image UNDER the tiles -->
    <img id="qr" alt="QR code">
    <div class="grid" id="grid" aria-live="polite"></div>
    <div class="banner" id="banner">Tap two tiles to swap. Solve to reveal QR.</div>
  </div>
</div>
<div class="toast" id="toast">Solved! Scan the QR.</div>

<script>
/* ===========================
   ðŸ”§ EDIT THIS VALUE ONLY ðŸ”§
   ===========================
   Put your QR image path/URL/data-URL below.
   Examples:
   const QR_SRC = "myqr.png";                         // file in same folder
   const QR_SRC = "https://example.com/qr.png";      // hosted image (same-origin preferred)
   const QR_SRC = "data:image/png;base64,iVBORw0K..."; // base64 data URL
*/
const QR_SRC = "qr.png";

/* Optional: change grid here too (overrides CSS variable if set) */
// const GRID = 4;

/* ===== INTERNALS (no need to edit) ===== */
const GRID = (typeof window.GRID === "number" ? window.GRID :
             parseInt(getComputedStyle(document.documentElement).getPropertyValue('--grid')) ) || 4;

const gridEl = document.getElementById('grid');
const qrEl   = document.getElementById('qr');
const toast  = document.getElementById('toast');
const puzzle = document.getElementById('puzzle');
const banner = document.getElementById('banner');

let sel = null;         // selected tile element
let solvedOnce = false; // lock after solved

function init() {
  qrEl.src = QR_SRC;
  if (!qrEl.complete) {
    qrEl.addEventListener('load', build, {once:true});
  } else {
    build();
  }
  window.addEventListener('resize', ()=>{/* layout is % based; nothing needed */});
}

function build(){
  const N = GRID * GRID;
  // Create initial order 0..N-1, then shuffle by swaps (always solvable for swap-puzzles)
  const order = Array.from({length:N}, (_,i)=>i);
  for (let i = 0; i < N*6; i++){
    const a = Math.floor(Math.random()*N);
    const b = Math.floor(Math.random()*N);
    [order[a], order[b]] = [order[b], order[a]];
  }

  // build tiles
  gridEl.innerHTML = '';
  sel = null; solvedOnce = false;
  gridEl.classList.remove('hidden');

  const src = qrEl.currentSrc || qrEl.src; // iOS-safe

  for (let pos = 0; pos < N; pos++){
    const idx = order[pos]; // which slice to show at this position
    const tile = document.createElement('div');
    tile.className = 'tile';
    tile.dataset.pos = String(pos);
    tile.dataset.idx = String(idx);
    tile.style.backgroundImage = `url("${src}")`;

    // Compute background position from idx
    const col = idx % GRID;
    const row = Math.floor(idx / GRID);
    const xPct = (GRID === 1) ? 0 : (col * 100 / (GRID - 1));
    const yPct = (GRID === 1) ? 0 : (row * 100 / (GRID - 1));
    tile.style.backgroundPosition = `${xPct}% ${yPct}%`;

    gridEl.appendChild(tile);
  }

  // Tap-to-swap handler (works on iOS/Android/Desktop)
  gridEl.addEventListener('click', onTap, {passive:true});
}

function onTap(e){
  const t = e.target.closest('.tile');
  if (!t || solvedOnce) return;

  if (!sel){
    sel = t; sel.classList.add('sel');
    return;
  }

  if (t === sel){
    sel.classList.remove('sel'); sel = null; return;
  }

  // Swap the "idx" each tile shows
  const aIdx = sel.dataset.idx;
  const bIdx = t.dataset.idx;
  sel.dataset.idx = bIdx;
  t.dataset.idx = aIdx;

  // Swap their backgroundPosition (faster than recalculating)
  const tmpPos = sel.style.backgroundPosition;
  sel.style.backgroundPosition = t.style.backgroundPosition;
  t.style.backgroundPosition = tmpPos;

  sel.classList.remove('sel'); sel = null;

  // Check solved: idx must equal pos for all tiles
  const tiles = gridEl.children;
  for (let i = 0; i < tiles.length; i++){
    if (tiles[i].dataset.idx !== tiles[i].dataset.pos) { return; }
  }
  onSolved();
}

function onSolved(){
  solvedOnce = true;
  gridEl.classList.add('hidden');            // show real QR for scanning
  banner.textContent = "Nice! Scan the QR to continue.";
  showToast('Solved! Scan the QR.');
  if (navigator.vibrate) navigator.vibrate(60);
}

let toastTimer;
function showToast(msg){
  toast.textContent = msg;
  toast.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> toast.classList.remove('show'), 1800);
}

init();
</script>
</body>
</html>
